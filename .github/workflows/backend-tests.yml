name: Backend Tests

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-tests.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-tests.yml'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: backend
        run: npm ci

      - name: Run ESLint
        working-directory: backend
        run: npm run lint
        continue-on-error: true

  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: backend
        run: npm ci

      - name: Run unit tests
        working-directory: backend
        run: npm test -- --coverage

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          directory: backend/coverage
          flags: backend-unit
          fail_ci_if_error: false

  test-integration:
    name: Integration Tests with LocalStack
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: artmanagement
          POSTGRES_USER: artuser
          POSTGRES_PASSWORD: dbpass
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      localstack:
        image: localstack/localstack:latest
        env:
          SERVICES: dynamodb,s3
          DEBUG: 1
          AWS_DEFAULT_REGION: us-east-1
        ports:
          - 4566:4566
        options: >-
          --health-cmd "curl -f http://localhost:4566/_localstack/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      # Database Configuration
      DB_HOST: localhost
      DB_PORT: 5432
      DB_USER: artuser
      DB_PASSWORD: dbpass
      DB_NAME: artmanagement
      DB_SSLMODE: disable

      # AWS Configuration (LocalStack)
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_ENDPOINT_URL: http://localhost:4566
      S3_BUCKET_NAME: art-images-test
      CDN_URL: http://localhost:4566/art-images-test

      # Application Configuration
      ENVIRONMENT: test
      JWT_SECRET: test-secret
      PAYMENT_PROVIDER: mock
      ETSY_SYNC_ENABLED: false
      SCHEDULER_ENABLED: false
      RATE_LIMIT_ENABLED: false

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: backend
        run: npm ci

      - name: Install AWS CLI
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install

      - name: Wait for LocalStack
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:4566/_localstack/health; do sleep 2; done'

      - name: Initialize LocalStack resources
        run: |
          # Create S3 bucket
          aws --endpoint-url=http://localhost:4566 s3 mb s3://art-images-test

          # Create DynamoDB tables
          aws --endpoint-url=http://localhost:4566 dynamodb create-table \
            --table-name products \
            --attribute-definitions AttributeName=id,AttributeType=S AttributeName=status,AttributeType=S AttributeName=createdAt,AttributeType=S \
            --key-schema AttributeName=id,KeyType=HASH \
            --global-secondary-indexes "IndexName=status-createdAt-index,KeySchema=[{AttributeName=status,KeyType=HASH},{AttributeName=createdAt,KeyType=RANGE}],Projection={ProjectionType=ALL},ProvisionedThroughput={ReadCapacityUnits=5,WriteCapacityUnits=5}" \
            --billing-mode PAY_PER_REQUEST

          aws --endpoint-url=http://localhost:4566 dynamodb create-table \
            --table-name orders \
            --attribute-definitions AttributeName=id,AttributeType=S AttributeName=userId,AttributeType=S AttributeName=createdAt,AttributeType=S \
            --key-schema AttributeName=id,KeyType=HASH \
            --global-secondary-indexes "IndexName=userId-createdAt-index,KeySchema=[{AttributeName=userId,KeyType=HASH},{AttributeName=createdAt,KeyType=RANGE}],Projection={ProjectionType=ALL},ProvisionedThroughput={ReadCapacityUnits=5,WriteCapacityUnits=5}" \
            --billing-mode PAY_PER_REQUEST

          aws --endpoint-url=http://localhost:4566 dynamodb create-table \
            --table-name carts \
            --attribute-definitions AttributeName=id,AttributeType=S AttributeName=userId,AttributeType=S \
            --key-schema AttributeName=id,KeyType=HASH \
            --global-secondary-indexes "IndexName=userId-index,KeySchema=[{AttributeName=userId,KeyType=HASH}],Projection={ProjectionType=ALL},ProvisionedThroughput={ReadCapacityUnits=5,WriteCapacityUnits=5}" \
            --billing-mode PAY_PER_REQUEST

          aws --endpoint-url=http://localhost:4566 dynamodb create-table \
            --table-name discount-codes \
            --attribute-definitions AttributeName=code,AttributeType=S \
            --key-schema AttributeName=code,KeyType=HASH \
            --billing-mode PAY_PER_REQUEST

          aws --endpoint-url=http://localhost:4566 dynamodb create-table \
            --table-name audit-logs \
            --attribute-definitions AttributeName=id,AttributeType=S AttributeName=entityType,AttributeType=S AttributeName=timestamp,AttributeType=S \
            --key-schema AttributeName=id,KeyType=HASH \
            --global-secondary-indexes "IndexName=entityType-timestamp-index,KeySchema=[{AttributeName=entityType,KeyType=HASH},{AttributeName=timestamp,KeyType=RANGE}],Projection={ProjectionType=ALL},ProvisionedThroughput={ReadCapacityUnits=5,WriteCapacityUnits=5}" \
            --billing-mode PAY_PER_REQUEST

          aws --endpoint-url=http://localhost:4566 dynamodb create-table \
            --table-name notifications \
            --attribute-definitions AttributeName=id,AttributeType=S AttributeName=userId,AttributeType=S AttributeName=createdAt,AttributeType=S \
            --key-schema AttributeName=id,KeyType=HASH \
            --global-secondary-indexes "IndexName=userId-createdAt-index,KeySchema=[{AttributeName=userId,KeyType=HASH},{AttributeName=createdAt,KeyType=RANGE}],Projection={ProjectionType=ALL},ProvisionedThroughput={ReadCapacityUnits=5,WriteCapacityUnits=5}" \
            --billing-mode PAY_PER_REQUEST

      - name: Run integration tests
        working-directory: backend
        run: npm run test:integration
        continue-on-error: true

  build:
    name: Build TypeScript
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: backend
        run: npm ci

      - name: Build
        working-directory: backend
        run: npm run build

      - name: Check build output
        working-directory: backend
        run: |
          if [ ! -d "dist" ]; then
            echo "Build failed: dist directory not created"
            exit 1
          fi
          echo "Build successful"
